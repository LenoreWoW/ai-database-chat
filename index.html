<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Database Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: #0d4261; /* Skyline */
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 100vw;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #8A1538; /* Al Adaam */
            border-right: 1px solid #A29475; /* Dune */
            display: flex;
            flex-direction: column;
            padding: 12px;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            color: #fdf39d; /* Sunrise */
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #A29475; /* Dune */
            line-height: 1.4;
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid #129b82; /* Palm */
            border-radius: 8px;
            background: transparent;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            margin-bottom: 16px;
        }

        .new-chat-btn:hover {
            background: #129b82; /* Palm */
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-info {
            padding: 12px;
            font-size: 11px;
            color: #A29475; /* Dune */
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: auto;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(162,148,117,0.2); /* Dune */
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #fdf39d; /* Sunrise */
        }

        .stat-label {
            font-size: 10px;
            color: #A29475; /* Dune */
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            max-width: calc(100vw - 260px);
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #A29475; /* Dune */
            background: #511C3C; /* Dark Purple */
            font-weight: 600;
            font-size: 16px;
            color: #fdf39d; /* Sunrise */
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: #0d4261; /* Skyline */
        }

        .message-wrapper {
            display: flex;
            padding: 20px 0;
            gap: 16px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .message-wrapper.user {
            background: rgba(18,155,130,0.05); /* Palm tint */
        }

        .message-wrapper.assistant {
            background: rgba(81,28,60,0.1); /* Dark Purple tint */
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .avatar.user {
            background: #129b82; /* Palm */
        }

        .avatar.assistant {
            background: #8A1538; /* Al Adaam */
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
            font-size: 15px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
        }

        .message-content pre {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #A29475; /* Dune */
            max-width: 100%;
        }

        .message-content .data-table {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            max-height: 300px;
            overflow: auto;
            border: 1px solid #A29475; /* Dune */
        }

        .message-content .sql-query {
            background: rgba(81,28,60,0.3); /* Dark Purple */
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 3px solid #fdf39d; /* Sunrise */
            overflow-x: auto;
        }

        .message-content .sql-query strong {
            color: #fdf39d; /* Sunrise */
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .message-content code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            background: #511C3C; /* Dark Purple */
            border-top: 1px solid #A29475; /* Dune */
        }

        .input-container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .input-wrapper {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            border: 2px solid #129b82; /* Palm */
            display: flex;
            align-items: center;
            padding: 12px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #fdf39d; /* Sunrise */
        }

        #questionInput {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #ffffff;
            font-size: 15px;
            resize: none;
            max-height: 150px;
            font-family: inherit;
        }

        #questionInput::placeholder {
            color: #A29475; /* Dune */
        }

        .send-btn {
            background: #129b82; /* Palm */
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background: #4194b3; /* Sea */
        }

        .send-btn:disabled {
            background: #A29475; /* Dune */
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Loading */
        .loading-indicator {
            display: none;
            padding: 20px 0;
        }

        .loading-indicator.active {
            display: flex;
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #fdf39d; /* Sunrise */
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Example prompts */
        .welcome-section {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
            color: #fdf39d; /* Sunrise */
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            max-width: 900px;
            margin: 0 auto;
        }

        .example-card {
            background: rgba(81,28,60,0.3); /* Dark Purple */
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #A29475; /* Dune */
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }

        .example-card:hover {
            background: rgba(18,155,130,0.2); /* Palm */
            border-color: #129b82; /* Palm */
            transform: translateY(-2px);
        }

        .example-card .title {
            font-weight: 600;
            margin-bottom: 6px;
            color: #fdf39d; /* Sunrise */
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .example-card .description {
            font-size: 12px;
            color: #A29475; /* Dune */
            line-height: 1.4;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #A29475; /* Dune */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #129b82; /* Palm */
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -260px;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                max-width: 100vw;
            }

            .examples-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>AI Database</h2>
                <p>Military Project Management System</p>
            </div>

            <button class="new-chat-btn" onclick="newChat()">
                <span>+</span>
                <span>New chat</span>
            </button>

            <div class="sidebar-content">
                <!-- Chat history would go here -->
            </div>

            <div class="sidebar-info">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">65</div>
                        <div class="stat-label">Tables</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">15</div>
                        <div class="stat-label">Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">41</div>
                        <div class="stat-label">Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">5</div>
                        <div class="stat-label">Departments</div>
                    </div>
                </div>
                <div style="font-size: 10px; text-align: center; margin-top: 8px;">
                    Powered by AI on Hugging Face
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                Military Project Database Assistant
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-section" id="welcomeSection">
                    <div class="welcome-title">Ask me anything about the database</div>

                    <div class="examples-grid">
                        <div class="example-card" onclick="askQuestion('How many projects are there?')">
                            <div class="title">üìä Project Count</div>
                            <div class="description">Get total number of projects</div>
                        </div>
                        <div class="example-card" onclick="askQuestion('Show me all departments')">
                            <div class="title">üè¢ Departments</div>
                            <div class="description">List all department names</div>
                        </div>
                        <div class="example-card" onclick="askQuestion('What is the total budget?')">
                            <div class="title">üí∞ Budget Info</div>
                            <div class="description">Calculate total budgets</div>
                        </div>
                        <div class="example-card" onclick="askQuestion('How many users are there?')">
                            <div class="title">üë• User Count</div>
                            <div class="description">Get total user count</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea
                            id="questionInput"
                            placeholder="Send a message..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                        <button class="send-btn" onclick="submitQuestion()" id="sendBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://im-lenore-aiready-database-api.hf.space';
        let sessionId = null;

        // Conversation detection patterns
        const GREETINGS = [
            /^(hi|hello|hey|greetings|good morning|good afternoon|good evening|sup|yo)[\s!.?]*$/i,
            /^how are you[\s!.?]*$/i,
            /^what'?s up[\s!.?]*$/i,
            /^nice to meet you[\s!.?]*$/i
        ];

        const CONVERSATIONAL = [
            /^(thank you|thanks|thx|ty)[\s!.?]*$/i,
            /^(bye|goodbye|see you|later)[\s!.?]*$/i,
            /^(ok|okay|alright|got it|cool)[\s!.?]*$/i,
            /^who (are you|made you|created you)[\s!.?]*$/i,
            /^what (can you do|are you)[\s!.?]*$/i,
            /^help[\s!.?]*$/i
        ];

        const CONVERSATIONAL_RESPONSES = {
            greeting: [
                "Hello! I'm your AI assistant for the military project database. I can help you query project data, user information, budgets, and more. What would you like to know?",
                "Hi there! I'm here to help you explore the database. Ask me anything about projects, departments, users, or budgets!",
                "Hey! Ready to dive into the data? I can answer questions about the military project database."
            ],
            thanks: [
                "You're welcome! Let me know if you need anything else.",
                "Happy to help! Feel free to ask more questions.",
                "My pleasure! What else can I help you with?"
            ],
            goodbye: [
                "Goodbye! Come back anytime you need to query the database.",
                "See you later! Happy to help anytime.",
                "Take care! I'll be here when you need me."
            ],
            capabilities: [
                "I can help you query the military project database! I understand natural language questions and convert them to SQL. Try asking about projects, users, departments, budgets, tasks, or any other data in the 65-table database.",
                "I'm an AI-powered database assistant. Ask me questions in plain English, and I'll query the database for you. For example: 'How many active projects?' or 'Show me all departments'."
            ],
            help: [
                "I can answer questions about the database in natural language. Try:\n‚Ä¢ 'How many projects are there?'\n‚Ä¢ 'Show me all departments'\n‚Ä¢ 'What's the total budget?'\n‚Ä¢ 'List all users'\n\nJust ask naturally and I'll figure out the SQL!",
                "Ask me anything about the database! I understand questions like 'How many users?', 'Show me project budgets', or 'List all departments'. Just type your question naturally."
            ],
            default: [
                "I'm here to help with database queries. Try asking about projects, users, departments, or budgets!",
                "Let me know what you'd like to find in the database!"
            ]
        };

        function isConversational(text) {
            for (let pattern of GREETINGS) {
                if (pattern.test(text)) {
                    return 'greeting';
                }
            }

            for (let pattern of CONVERSATIONAL) {
                if (pattern.test(text)) {
                    if (/thank/i.test(text)) return 'thanks';
                    if (/bye|goodbye|see you|later/i.test(text)) return 'goodbye';
                    if (/who|what (are you|can you)/i.test(text)) return 'capabilities';
                    if (/help/i.test(text)) return 'help';
                    return 'default';
                }
            }

            return null;
        }

        function getConversationalResponse(type) {
            const responses = CONVERSATIONAL_RESPONSES[type] || CONVERSATIONAL_RESPONSES.default;
            return responses[Math.floor(Math.random() * responses.length)];
        }

        async function submitQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();

            if (!question) return;

            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }

            addMessage(question, 'user');
            input.value = '';
            autoResize(input);

            document.getElementById('sendBtn').disabled = true;

            const conversationType = isConversational(question);

            if (conversationType) {
                setTimeout(() => {
                    const response = getConversationalResponse(conversationType);
                    addMessage(response, 'assistant');
                    document.getElementById('sendBtn').disabled = false;
                }, 500);
                return;
            }

            const loadingId = showLoading();

            try {
                const response = await fetch(`${API_BASE}/api/v1/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        session_id: sessionId,
                        include_sql: true
                    })
                });

                const data = await response.json();

                if (data.success) {
                    sessionId = data.session_id;
                    const responseHtml = formatDatabaseResponse(data);
                    addMessage(responseHtml, 'assistant');
                } else {
                    addMessage(`I encountered an error while querying the database: ${data.error}\n\nPlease try rephrasing your question or ask something else.`, 'assistant');
                }
            } catch (error) {
                addMessage('Sorry, I could not connect to the database. Please check your connection and try again.', 'assistant');
                console.error('Error:', error);
            } finally {
                hideLoading(loadingId);
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function formatDatabaseResponse(data) {
            let html = '';

            if (data.row_count === 0) {
                html += 'No results found for your query.';
            } else if (data.row_count === 1 && data.data[0] && Object.keys(data.data[0]).length === 1) {
                const value = Object.values(data.data[0])[0];
                html += `The answer is: <strong>${value}</strong>`;
            } else if (data.row_count <= 10) {
                html += `I found ${data.row_count} result${data.row_count > 1 ? 's' : ''}:\n\n`;
                html += '<div class="data-table"><pre>' + JSON.stringify(data.data, null, 2) + '</pre></div>';
            } else {
                html += `I found ${data.row_count} results. Here are the first 10:\n\n`;
                html += '<div class="data-table"><pre>' + JSON.stringify(data.data.slice(0, 10), null, 2) + '</pre></div>';
                html += `\n<em>...and ${data.row_count - 10} more rows</em>`;
            }

            if (data.sql) {
                html += `\n\n<div class="sql-query"><strong>SQL Query:</strong>\n<code>${escapeHtml(data.sql)}</code></div>`;
            }

            if (data.execution_time_ms) {
                html += `\n\n<small>‚ö° Executed in ${data.execution_time_ms.toFixed(2)}ms</small>`;
            }

            return html;
        }

        function addMessage(text, type) {
            const chatContainer = document.getElementById('chatContainer');

            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${type}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${type}`;
            avatar.textContent = type === 'user' ? 'üë§' : 'ü§ñ';

            const content = document.createElement('div');
            content.className = 'message-content';

            const formattedText = text.replace(/\n/g, '<br>');
            content.innerHTML = formattedText;

            wrapper.appendChild(avatar);
            wrapper.appendChild(content);
            chatContainer.appendChild(wrapper);

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        let loadingCounter = 0;

        function showLoading() {
            const chatContainer = document.getElementById('chatContainer');
            const id = `loading-${loadingCounter++}`;

            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper assistant loading-indicator active';
            wrapper.id = id;

            const avatar = document.createElement('div');
            avatar.className = 'avatar assistant';
            avatar.textContent = 'ü§ñ';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';

            wrapper.appendChild(avatar);
            wrapper.appendChild(content);
            chatContainer.appendChild(wrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return id;
        }

        function hideLoading(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }

        function askQuestion(question) {
            document.getElementById('questionInput').value = question;
            submitQuestion();
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                submitQuestion();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function newChat() {
            sessionId = null;
            document.getElementById('chatContainer').innerHTML = '';
            const welcomeSection = document.createElement('div');
            welcomeSection.className = 'welcome-section';
            welcomeSection.id = 'welcomeSection';
            welcomeSection.innerHTML = `
                <div class="welcome-title">Ask me anything about the database</div>

                <div class="examples-grid">
                    <div class="example-card" onclick="askQuestion('How many projects are there?')">
                        <div class="title">üìä Project Count</div>
                        <div class="description">Get total number of projects</div>
                    </div>
                    <div class="example-card" onclick="askQuestion('Show me all departments')">
                        <div class="title">üè¢ Departments</div>
                        <div class="description">List all department names</div>
                    </div>
                    <div class="example-card" onclick="askQuestion('What is the total budget?')">
                        <div class="title">üí∞ Budget Info</div>
                        <div class="description">Calculate total budgets</div>
                    </div>
                    <div class="example-card" onclick="askQuestion('How many users are there?')">
                        <div class="title">üë• User Count</div>
                        <div class="description">Get total user count</div>
                    </div>
                </div>
            `;
            document.getElementById('chatContainer').appendChild(welcomeSection);
        }

        window.onload = function() {
            document.getElementById('questionInput').focus();
        };
    </script>
</body>
</html>
